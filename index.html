<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Book Tracker</title>
    
    <!-- Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- React Libraries -->
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    
    <!-- Babel to translate JSX in the browser -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- Chart.js for statistics -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        /* Simple body style to match the theme */
        body {
            background-color: #111827; /* bg-gray-900 */
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <!-- The entire React Application -->
    <script type="text/babel" data-type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-app.js";
        import { 
            getAuth, 
            onAuthStateChanged, 
            createUserWithEmailAndPassword, 
            signInWithEmailAndPassword, 
            signOut 
        } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-auth.js";
        import { 
            getFirestore, 
            collection, 
            addDoc, 
            query, 
            where, 
            getDocs,
            doc,
            updateDoc
        } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js";

        const { useState, useEffect, useMemo, useRef } = React;

        // --- IMPORTANT ---
        // Your web app's Firebase configuration
        const firebaseConfig = {
          apiKey: "AIzaSyCWiDK8pm24MEKDC8DmcR68VwgWKx2j5eM",
          authDomain: "book-tracker-v2.firebaseapp.com",
          projectId: "book-tracker-v2",
          storageBucket: "book-tracker-v2.appspot.com",
          messagingSenderId: "148759504044",
          appId: "1:148759504044:web:5332ca5553a0cd2a92ab09"
        };

        // Your Google Books API Key
        const GOOGLE_BOOKS_API_KEY = 'AIzaSyDEzTQ4nm3Hw8iPnW8ZRKYsCcYCG_oJwb4';

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // --- Main App Component ---
        function App() {
            const [user, setUser] = useState(null);
            const [loading, setLoading] = useState(true);

            useEffect(() => {
                const unsubscribe = onAuthStateChanged(auth, (user) => {
                    setUser(user);
                    setLoading(false);
                });
                return () => unsubscribe();
            }, []);

            if (loading) {
                return <div className="flex items-center justify-center h-screen bg-gray-900 text-white">Loading...</div>;
            }

            return (
                <div className="min-h-screen bg-gray-900 text-gray-100 font-sans">
                    {user ? <Dashboard user={user} /> : <Login />}
                </div>
            );
        }

        // --- Login/Signup Component ---
        function Login() {
            const [email, setEmail] = useState('');
            const [password, setPassword] = useState('');
            const [error, setError] = useState('');
            const [isSignUp, setIsSignUp] = useState(false);

            const handleAuth = async (e) => {
                e.preventDefault();
                setError('');
                try {
                    if (isSignUp) {
                        await createUserWithEmailAndPassword(auth, email, password);
                    } else {
                        await signInWithEmailAndPassword(auth, email, password);
                    }
                } catch (err) {
                    setError(err.message);
                }
            };

            return (
                <div className="flex items-center justify-center h-screen">
                    <div className="w-full max-w-md p-8 space-y-6 bg-gray-800 rounded-lg shadow-lg">
                        <h2 className="text-2xl font-bold text-center text-white">{isSignUp ? 'Create Account' : 'Welcome Back'}</h2>
                        <form onSubmit={handleAuth} className="space-y-6">
                            <div>
                                <label className="text-sm font-bold text-gray-400">Email</label>
                                <input
                                    type="email"
                                    value={email}
                                    onChange={(e) => setEmail(e.target.value)}
                                    className="w-full p-3 mt-1 text-gray-200 bg-gray-700 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500"
                                    required
                                />
                            </div>
                            <div>
                                <label className="text-sm font-bold text-gray-400">Password</label>
                                <input
                                    type="password"
                                    value={password}
                                    onChange={(e) => setPassword(e.target.value)}
                                    className="w-full p-3 mt-1 text-gray-200 bg-gray-700 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500"
                                    required
                                />
                            </div>
                            {error && <p className="text-sm text-red-400">{error}</p>}
                            <button type="submit" className="w-full py-3 font-bold text-white bg-indigo-600 rounded-md hover:bg-indigo-700 transition duration-300">
                                {isSignUp ? 'Sign Up' : 'Login'}
                            </button>
                        </form>
                        <p className="text-sm text-center text-gray-400">
                            {isSignUp ? 'Already have an account?' : "Don't have an account?"}
                            <button onClick={() => setIsSignUp(!isSignUp)} className="ml-1 font-bold text-indigo-400 hover:underline">
                                {isSignUp ? 'Login' : 'Sign Up'}
                            </button>
                        </p>
                    </div>
                </div>
            );
        }

        // --- Main Dashboard Component ---
        function Dashboard({ user }) {
            const [view, setView] = useState('stats'); // stats, gallery, add
            const [books, setBooks] = useState([]);
            const [loadingBooks, setLoadingBooks] = useState(true);

            const fetchBooks = async () => {
                setLoadingBooks(true);
                const q = query(collection(db, "readings"), where("userId", "==", user.uid));
                const querySnapshot = await getDocs(q);
                const userBooks = querySnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                userBooks.sort((a, b) => new Date(b.readDate) - new Date(a.readDate));
                setBooks(userBooks);
                setLoadingBooks(false);
            };

            useEffect(() => {
                fetchBooks();
            }, [user]);

            const handleBookAdded = () => {
                fetchBooks();
                setView('stats');
            };
            
            const handleBookUpdated = () => {
                fetchBooks();
            };

            return (
                <div className="p-4 md:p-8">
                    <Navbar user={user} setView={setView} currentView={view} />
                    <main className="mt-8">
                        {view === 'add' && <AddBook onBookAdded={handleBookAdded} />}
                        {view === 'stats' && <Stats books={books} loading={loadingBooks} onBookUpdated={handleBookUpdated} />}
                        {view === 'gallery' && <Gallery books={books} loading={loadingBooks} onBookUpdated={handleBookUpdated} />}
                    </main>
                </div>
            );
        }

        // --- Navbar Component ---
        function Navbar({ user, setView, currentView }) {
            const activeClass = "bg-indigo-600 text-white";
            const inactiveClass = "text-gray-300 hover:bg-gray-700 hover:text-white";

            return (
                <header className="flex flex-col md:flex-row justify-between items-center">
                    <h1 className="text-3xl font-bold text-white mb-4 md:mb-0">Book Tracker</h1>
                    <nav className="flex items-center space-x-2 bg-gray-800 p-2 rounded-lg">
                        <button onClick={() => setView('stats')} className={`px-3 py-2 rounded-md text-sm font-medium ${currentView === 'stats' ? activeClass : inactiveClass}`}>Stats</button>
                        <button onClick={() => setView('gallery')} className={`px-3 py-2 rounded-md text-sm font-medium ${currentView === 'gallery' ? activeClass : inactiveClass}`}>Gallery</button>
                        <button onClick={() => setView('add')} className={`px-3 py-2 rounded-md text-sm font-medium ${currentView === 'add' ? activeClass : inactiveClass}`}>+ Add Book</button>
                    </nav>
                    <div className="hidden md:flex items-center space-x-4">
                        <span className="text-sm text-gray-400">{user.email}</span>
                        <button onClick={() => signOut(auth)} className="px-4 py-2 text-sm font-medium text-white bg-red-600 rounded-md hover:bg-red-700">Logout</button>
                    </div>
                </header>
            );
        }

        // --- Add Book Component ---
        function AddBook({ onBookAdded }) {
            const [isbn, setIsbn] = useState('');
            const [bookData, setBookData] = useState(null);
            const [loading, setLoading] = useState(false);
            const [error, setError] = useState('');
            const [readDate, setReadDate] = useState(new Date().toISOString().split('T')[0]);

            const handleIsbnSearch = async (e) => {
                e.preventDefault();
                setLoading(true);
                setError('');
                setBookData(null);
                try {
                    const url = `https://www.googleapis.com/books/v1/volumes?q=isbn:${isbn}${GOOGLE_BOOKS_API_KEY ? '&key=' + GOOGLE_BOOKS_API_KEY : ''}`;
                    const response = await fetch(url);
                    const data = await response.json();
                    if (data.totalItems > 0) {
                        const book = data.items[0].volumeInfo;
                        setBookData({
                            title: book.title || 'N/A',
                            author: book.authors ? book.authors.join(', ') : 'N/A',
                            isFiction: book.categories ? !book.categories.some(c => c.toLowerCase().includes('nonfiction')) : true,
                            genre: book.categories ? book.categories[0] : 'General',
                            publicationYear: book.publishedDate ? new Date(book.publishedDate).getFullYear() : 'N/A',
                            coverUrl: book.imageLinks?.thumbnail || `https://placehold.co/128x192/1f2937/ffffff?text=${book.title.split(' ').join('+')}`,
                        });
                    } else {
                        setError('Book not found for this ISBN.');
                    }
                } catch (err) {
                    setError('Failed to fetch book data. Please check the ISBN and your connection.');
                }
                setLoading(false);
            };

            const handleAddBook = async (e) => {
                e.preventDefault();
                if (!bookData) return;
                
                const bookToAdd = {
                    ...bookData,
                    isbn,
                    readDate,
                    readYear: new Date(readDate).getFullYear(),
                    userId: auth.currentUser.uid,
                    isWeirdest: false,
                };

                try {
                    await addDoc(collection(db, "readings"), bookToAdd);
                    setIsbn('');
                    setBookData(null);
                    setReadDate(new Date().toISOString().split('T')[0]);
                    onBookAdded();
                } catch (err) {
                    setError('Failed to save book to your library.');
                }
            };

            return (
                <div className="max-w-2xl mx-auto p-6 bg-gray-800 rounded-lg">
                    <h2 className="text-xl font-bold mb-4">Add a New Book</h2>
                    <form onSubmit={handleIsbnSearch} className="flex gap-2 mb-4">
                        <input
                            type="text"
                            value={isbn}
                            onChange={(e) => setIsbn(e.target.value)}
                            placeholder="Enter 10 or 13-digit ISBN"
                            className="flex-grow p-2 bg-gray-700 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500"
                        />
                        <button type="submit" disabled={loading} className="px-4 py-2 font-bold text-white bg-indigo-600 rounded-md hover:bg-indigo-700 disabled:bg-gray-500">
                            {loading ? 'Searching...' : 'Find Book'}
                        </button>
                    </form>
                    {error && <p className="text-red-400 mb-4">{error}</p>}

                    {bookData && (
                        <form onSubmit={handleAddBook}>
                            <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
                                <div className="md:col-span-1">
                                    <img src={bookData.coverUrl} alt={bookData.title} className="w-full h-auto object-cover rounded-md shadow-lg" />
                                </div>
                                <div className="md:col-span-2 space-y-4">
                                    <h3 className="text-2xl font-bold">{bookData.title}</h3>
                                    <p className="text-gray-400">by {bookData.author}</p>
                                    <div>
                                        <label className="block text-sm font-medium text-gray-400">Date Read</label>
                                        <input type="date" value={readDate} onChange={e => setReadDate(e.target.value)} className="w-full p-2 mt-1 bg-gray-700 rounded-md" />
                                    </div>
                                    <div>
                                        <label className="block text-sm font-medium text-gray-400">Genre</label>
                                        <input type="text" value={bookData.genre} onChange={e => setBookData({...bookData, genre: e.target.value})} className="w-full p-2 mt-1 bg-gray-700 rounded-md" />
                                    </div>
                                    <div>
                                        <label className="block text-sm font-medium text-gray-400">Type</label>
                                        <select value={bookData.isFiction} onChange={e => setBookData({...bookData, isFiction: e.target.value === 'true'})} className="w-full p-2 mt-1 bg-gray-700 rounded-md">
                                            <option value="true">Fiction</option>
                                            <option value="false">Non-Fiction</option>
                                        </select>
                                    </div>
                                    <div>
                                        <label className="block text-sm font-medium text-gray-400">Cover Image URL</label>
                                        <input type="text" value={bookData.coverUrl} onChange={e => setBookData({...bookData, coverUrl: e.target.value})} className="w-full p-2 mt-1 bg-gray-700 rounded-md" />
                                    </div>
                                    <button type="submit" className="w-full py-3 font-bold text-white bg-green-600 rounded-md hover:bg-green-700">Add to Library</button>
                                </div>
                            </div>
                        </form>
                    )}
                </div>
            );
        }

        // --- Stats Component ---
        function Stats({ books, loading, onBookUpdated }) {
            const [year, setYear] = useState(new Date().getFullYear());
            const pieChartRef = useRef(null);
            const barChartRef = useRef(null);
            
            const availableYears = useMemo(() => {
                const years = new Set(books.map(b => b.readYear));
                const currentYear = new Date().getFullYear();
                for (let y = currentYear; y >= 2014; y--) {
                    years.add(y);
                }
                return Array.from(years).sort((a, b) => b - a);
            }, [books]);

            const stats = useMemo(() => {
                const filteredBooks = books.filter(b => b.readYear === year);
                if (filteredBooks.length === 0) return null;

                const fictionCount = filteredBooks.filter(b => b.isFiction).length;
                const nonfictionCount = filteredBooks.length - fictionCount;

                const genreCounts = filteredBooks.reduce((acc, book) => {
                    acc[book.genre] = (acc[book.genre] || 0) + 1;
                    return acc;
                }, {});

                const authorCounts = filteredBooks.reduce((acc, book) => {
                    acc[book.author] = (acc[book.author] || 0) + 1;
                    return acc;
                }, {});
                const mostReadAuthor = Object.entries(authorCounts).sort((a, b) => b[1] - a[1])[0];

                const monthlyCounts = Array(12).fill(0);
                filteredBooks.forEach(book => {
                    const month = new Date(book.readDate).getMonth();
                    monthlyCounts[month]++;
                });
                
                const weirdestBook = filteredBooks.find(b => b.isWeirdest);

                return {
                    total: filteredBooks.length, fictionCount, nonfictionCount, genreCounts,
                    mostReadAuthor: mostReadAuthor ? `${mostReadAuthor[0]} (${mostReadAuthor[1]} books)` : 'N/A',
                    monthlyCounts, weirdestBook
                };
            }, [year, books]);

            useEffect(() => {
                let pieChartInstance;
                let barChartInstance;

                if (stats) {
                    // Create Pie Chart
                    const pieCtx = document.getElementById('pie-chart')?.getContext('2d');
                    if (pieCtx) {
                        pieChartInstance = new Chart(pieCtx, {
                            type: 'pie',
                            data: {
                                labels: ['Fiction', 'Non-Fiction'],
                                datasets: [{
                                    data: [stats.fictionCount, stats.nonfictionCount],
                                    backgroundColor: ['#818cf8', '#f87171'],
                                    borderColor: '#1f2937',
                                }]
                            },
                            options: { plugins: { legend: { labels: { color: 'white' }}}}
                        });
                    }

                    // Create Bar Chart
                    const barCtx = document.getElementById('bar-chart')?.getContext('2d');
                    if (barCtx) {
                        barChartInstance = new Chart(barCtx, {
                            type: 'bar',
                            data: {
                                labels: Object.keys(stats.genreCounts),
                                datasets: [{
                                    label: 'Books per Genre',
                                    data: Object.values(stats.genreCounts),
                                    backgroundColor: '#818cf8',
                                }]
                            },
                            options: {
                                scales: {
                                    y: { ticks: { color: 'white', stepSize: 1 }, grid: { color: '#4b5563' } },
                                    x: { ticks: { color: 'white' } }
                                },
                                plugins: { legend: { display: false }}
                            }
                        });
                    }
                }

                // Cleanup function to destroy charts on re-render
                return () => {
                    if (pieChartInstance) pieChartInstance.destroy();
                    if (barChartInstance) barChartInstance.destroy();
                };
            }, [stats]);


            if (loading) return <p>Loading stats...</p>;

            return (
                <div>
                    <div className="flex items-center gap-4 mb-6">
                        <h2 className="text-2xl font-bold">Statistics for</h2>
                        <select value={year} onChange={e => setYear(Number(e.target.value))} className="p-2 bg-gray-700 rounded-md">
                            {availableYears.map(y => <option key={y} value={y}>{y}</option>)}
                        </select>
                    </div>

                    {!stats ? (
                        <p className="text-gray-400">No books read in {year}. Add one to see your stats!</p>
                    ) : (
                        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                            <div className="p-4 bg-gray-800 rounded-lg"><h3 className="font-bold text-lg mb-2">Total Books Read</h3><p className="text-5xl font-bold text-indigo-400">{stats.total}</p></div>
                            <div className="p-4 bg-gray-800 rounded-lg"><h3 className="font-bold text-lg mb-2">Most Read Author</h3><p className="text-3xl font-bold text-indigo-400">{stats.mostReadAuthor}</p></div>
                            <div className="p-4 bg-gray-800 rounded-lg"><h3 className="font-bold text-lg mb-2">Weirdest Book of {year}</h3>{stats.weirdestBook ? <p className="text-xl font-bold text-indigo-400">{stats.weirdestBook.title}</p> : <p className="text-gray-400 text-sm">No book marked as "weirdest" yet.</p>}</div>
                            
                            <div className="p-4 bg-gray-800 rounded-lg md:col-span-1"><h3 className="font-bold text-lg mb-2">Fiction vs. Non-Fiction</h3><canvas id="pie-chart"></canvas></div>
                            <div className="p-4 bg-gray-800 rounded-lg md:col-span-2"><h3 className="font-bold text-lg mb-2">Top Genres</h3><canvas id="bar-chart"></canvas></div>

                            <div className="p-4 bg-gray-800 rounded-lg md:col-span-3">
                                <h3 className="font-bold text-lg mb-2">Monthly Reading Heatmap</h3>
                                <div className="grid grid-cols-6 md:grid-cols-12 gap-2 mt-4">
                                    {['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'].map((month, i) => {
                                        const count = stats.monthlyCounts[i];
                                        const maxCount = Math.max(...stats.monthlyCounts);
                                        const opacity = maxCount > 0 ? (count / maxCount) : 0;
                                        return (
                                            <div key={month} className="flex flex-col items-center">
                                                <div className="w-full h-16 rounded-md flex items-center justify-center" style={{ backgroundColor: `rgba(129, 140, 248, ${opacity})` }}>
                                                    <span className="font-bold text-white text-xl">{count}</span>
                                                </div>
                                                <p className="text-xs mt-1 text-gray-400">{month}</p>
                                            </div>
                                        );
                                    })}
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        }

        // --- Gallery Component ---
        function Gallery({ books, loading, onBookUpdated }) {
            const allYears = useMemo(() => {
                const years = new Set(books.map(b => b.readYear));
                for (let y = new Date().getFullYear(); y >= 2014; y--) years.add(y);
                return Array.from(years).sort((a, b) => b - a);
            }, [books]);

            const [selectedYears, setSelectedYears] = useState([new Date().getFullYear()]);

            const handleYearToggle = (year) => {
                setSelectedYears(prev => prev.includes(year) ? prev.filter(y => y !== year) : [...prev, year]);
            };

            const filteredBooks = useMemo(() => {
                return books.filter(b => selectedYears.includes(b.readYear));
            }, [selectedYears, books]);

            const setWeirdestBook = async (bookId, currentYear) => {
                const yearBooks = books.filter(b => b.readYear === currentYear);
                for (const book of yearBooks) {
                    if (book.isWeirdest && book.id !== bookId) {
                        const bookRef = doc(db, "readings", book.id);
                        await updateDoc(bookRef, { isWeirdest: false });
                    }
                }
                const bookRef = doc(db, "readings", bookId);
                const currentBook = books.find(b => b.id === bookId);
                await updateDoc(bookRef, { isWeirdest: !currentBook.isWeirdest });
                onBookUpdated();
            };

            if (loading) return <p>Loading gallery...</p>;

            return (
                <div>
                    <div className="mb-6">
                        <h2 className="text-2xl font-bold mb-2">Year in Review</h2>
                        <div className="flex flex-wrap gap-2">
                            {allYears.map(year => (
                                <button
                                    key={year}
                                    onClick={() => handleYearToggle(year)}
                                    className={`px-4 py-2 rounded-full text-sm font-medium transition ${selectedYears.includes(year) ? 'bg-indigo-600 text-white' : 'bg-gray-700 text-gray-300'}`}
                                >
                                    {year}
                                </button>
                            ))}
                        </div>
                    </div>

                    {filteredBooks.length > 0 ? (
                        <div className="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-6 xl:grid-cols-8 gap-4">
                            {filteredBooks.map(book => (
                                <div key={book.id} className="group relative">
                                    <img 
                                        src={book.coverUrl} 
                                        alt={`Cover of ${book.title}`}
                                        className="w-full h-auto object-cover rounded-md shadow-lg transform group-hover:scale-105 transition-transform duration-300"
                                    />
                                    <div className="absolute inset-0 bg-black bg-opacity-70 flex flex-col items-center justify-center p-2 text-center opacity-0 group-hover:opacity-100 transition-opacity duration-300 rounded-md">
                                        <p className="text-white font-bold text-sm">{book.title}</p>
                                        <p className="text-gray-300 text-xs mt-1">{book.author}</p>
                                        <button 
                                            onClick={() => setWeirdestBook(book.id, book.readYear)}
                                            className={`mt-2 px-2 py-1 text-xs rounded ${book.isWeirdest ? 'bg-yellow-400 text-black' : 'bg-gray-600 text-white'}`}
                                        >
                                            {book.isWeirdest ? '★ Weirdest' : 'Mark as Weirdest'}
                                        </button>
                                    </div>
                                </div>
                            ))}
                        </div>
                    ) : (
                        <p className="text-gray-400">No books found for the selected year(s).</p>
                    )}
                </div>
            );
        }

        // Render the app
        const container = document.getElementById('root');
        const root = ReactDOM.createRoot(container);
        root.render(<App />);

    </script>
</body>
</html>
